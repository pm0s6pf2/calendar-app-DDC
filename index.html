<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step4.2 - multi-cache.html</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Yu Gothic UI", sans-serif; margin: 16px; }
    h1 { font-size: 1.2rem; margin-bottom: var(--gap); }
    .row { display: flex; flex-wrap: wrap; gap: var(--gap); align-items: center; }
    button { padding: 10px 14px; font-size: 16px; border-radius: 10px; border: 1px solid #ddd; cursor: pointer; background: #fff; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    #status { margin-top: 8px; color: #0056b3; }
    #picker { margin-top: var(--gap); display: none; gap: var(--gap); }
    select, input[type="text"] { font-size: 14px; padding: 8px; border-radius: 8px; border: 1px solid #ddd; min-width: 260px; }

    #stage { position: relative; margin-top: 16px; }
    .frame { width: 100%; max-width: 960px; margin-inline: auto; background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 12px; }
    .viewport { position: relative; width: 100%; aspect-ratio: 4 / 3; display: grid; place-items: center; overflow: hidden; background: #fff; }
    img#photo { max-width: 100%; max-height: 100%; width: auto; height: auto; display: block; }
    #overlay { position: absolute; inset: 0; display: none; background: rgba(0,0,0,.55); color: white; align-items: center; justify-content: center; text-align: center; padding: 16px; white-space: pre-wrap; }
    #overlay.show { display: flex; }
    #filename { margin-top: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: #666; font-size: .9rem; }
  </style>
</head>
<body>
  <h1>Step4.2: 今日±n日を先読みキャッシュする</h1>

  <div class="row">
    <button id="login" disabled>Google Drive にログイン</button>
    <button id="logout" style="display:none;">ログアウト</button>
    <button id="choose" style="display:none;">フォルダを選択</button>
    <button id="showToday" style="display:none;">今日の画像を表示</button>
    <button id="checkCacheBtn" disabled>キャッシュ使用量を確認</button>
    <div id="cacheInfo" style="margin-top:10px; font-size:14px; color:#555;"></div>
  </div>
  <!-- 日単位の移動-->
  <div id="navDay" class="row" style="display:none; margin-top:12px;">
    <button id="prevDay">◀ 昨日</button>
    <button id="nextDay">明日 ▶</button>
  </div>

  <!--年単位の移動-->
  <div id="navYear" class="row" style="display:none; margin-top:12px;">
    <button id="prevYear">⏪ 昨年</button>
    <button id="nextYear">来年 ⏩</button>
  </div>

  <div id="status" class="muted">未ログイン</div>

  <div id="picker" class="row">
    <select id="folderList" aria-label="フォルダ一覧"></select>
    <button id="saveFolder">保存</button>
  </div>
  <div class="muted" id="remembered"></div>

  <div id="stage" class="frame">
    <div class="viewport">
      <!-- レイアウトシフト対策：プレースホルダ領域を aspect-ratio で確保 -->
      <img id="photo" alt="今日の画像" width="1600" height="1200" />
      <div id="overlay"></div>
    </div>
    <div id="filename" class="muted"></div>
  </div>

  <script>
    // ====== 設定 ======
    // ※ 必ずあなたの OAuth クライアントIDに置き換えてください（Step1 と同じもの）
    const CLIENT_ID = "432542663306-gajl9s636n960rmul1a630e2k9lchdl3.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
    const TIMEZONE = "Asia/Tokyo"; // テスト項目でのタイムゾーンズレ対策
    const CACHE_NAME = "image-cache-v1" ;

    // ====== 状態 ======
    let tokenClient;
    let gapiReady = false;
    let gisReady = false;
    let lastObjectURL = null; // 直前の Blob URL を保持（失敗時は前の画像を残す）
    let currentDate = new Date(); //今表示している日付

    // ====== ユーティリティ ======
    const $ = (sel) => document.querySelector(sel);
    function setStatus(msg, isError = false) {
      const el = $("#status");
      el.textContent = msg;
      el.style.color = isError ? "crimson" : "#0056b3";
    }
    function showOverlay(message) {
      const el = $("#overlay");
      el.textContent = message;
      el.classList.add("show");
    }
    function hideOverlay() {
      const el = $("#overlay");
      el.textContent = "";
      el.classList.remove("show");
    }
    function clearImage() {
      if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
      lastObjectURL = null;
      $("#photo").src = "";
      $("#filename").textContent = "";
      hideOverlay();
    }
    function getSavedFolderId() { return localStorage.getItem("selectedFolderId"); }
    function dateToYMD(date) {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: TIMEZONE,
        year: "numeric", month: "2-digit", day: "2-digit",
      }).formatToParts(date);
      const y = parts.find(p => p.type === "year").value;
      const m = parts.find(p => p.type === "month").value;
      const d = parts.find(p => p.type === "day").value;
      return `${y}-${m}-${d}`;
    }

    async function ensureToken() {
      let token = gapi.client.getToken();
      if (!token) {
        await new Promise((resolve) => {
          tokenClient.callback = () => resolve();
          tokenClient.requestAccessToken({ prompt: "" }); // サイレント更新
        });
        token = gapi.client.getToken();
      }
      return token.access_token;
    }

    async function findImageFile(folderId, baseName) {
      // まずは .png を優先（テスト要件）。見つからなければ jpg/jpeg も試す。
      const names = [`${baseName}.png`, `${baseName}.jpg`, `${baseName}.jpeg`];
      for (const name of names) {
        try {
          const res = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and name='${name}' and trashed=false`,
            fields: "files(id,name,mimeType,size,modifiedTime)",
            pageSize: 1,
            includeItemsFromAllDrives: true,
            supportsAllDrives: true,
          });
          const files = res.result.files || [];
          if (files.length > 0) return files[0];
        } catch (e) {
          if (e.status === 401) { await ensureToken(); continue; }
          throw e;
        }
      }
      return null;
    }

    async function displayByBaseName(folderId, baseName) {
      setStatus("検索中…");
      hideOverlay();
      try {
        // 1 先にキャッシュを確認
        const cache = await caches.open(CACHE_NAME);
        const cachedResponse = await cache.match(baseName);
        if (cachedResponse) {
          const blob = await cachedResponse.blob();
          if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
          lastObjectURL = URL.createObjectURL(blob);
          $("#photo").src = lastObjectURL;
          $("#filename").textContent = `${baseName}（キャッシュから表示）`;
          // キャッシュ命中時
          setStatus(`✅ キャッシュから表示: ${baseName}`);
          return true;
        }

        // 2 Drive からファイル検索
               const file = await findImageFile(folderId, baseName);
        if (!file) {
          setStatus("画像が見つかりません");
          showOverlay(`"${baseName}.png" が見つかりませんでした。\nフォルダやファイル名（YYYY-MM-DD.png）を確認してください。`);
          return false; // 失敗
        }

        const accessToken = await ensureToken();
        const url = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
        const resp = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
        if (!resp.ok) {
          if (resp.status === 401) { await ensureToken(); return await displayByBaseName(folderId, baseName); }
          throw new Error(`取得失敗: ${resp.status}`);
        }
        const blob = await resp.blob();

        // --- ここでキャッシュ保存 ---
        const responseForCache = new Response(blob, {
          headers: { "Content-Type": file.mimeType }
        });
        await cache.put(baseName, responseForCache);
        // ----------------------------

        if (lastObjectURL) URL.revokeObjectURL(lastObjectURL);
        lastObjectURL = URL.createObjectURL(blob);
        $("#photo").src = lastObjectURL;
        $("#filename").textContent = `${file.name}（最終更新: ${new Date(file.modifiedTime).toLocaleString('ja-JP', { timeZone: TIMEZONE })}）`;
        // Driveから新規取得成功時
        setStatus(`🌐 ネットワークから取得して表示: ${file.name}`);
        await showCacheUsage(); // ← キャッシュ状況を更新
        return true;       
        return true; // 成功
      } catch (e) {
        console.error(e);
        setStatus("エラー: " + e.message, true);
        showOverlay("通信に失敗しました。再試行してください。");
        return false;
      }
    }

    // キャッシュ使用量を計算して表示
    async function showCacheUsage() {
      const cache = await caches.open(CACHE_NAME);
      const keys = await cache.keys();

      let totalSize = 0;
      for (const req of keys) {
        const resp = await cache.match(req);
        if (resp) {
          const blob = await resp.blob();
          totalSize += blob.size;
        }
      }
      const mb = (totalSize / (1024 * 1024)).toFixed(2);
      document.getElementById("cacheInfo").textContent = `キャッシュ使用量: ${mb} MB (${keys.length}ファイル)`;
    }



    // 指定日付で画像を表示する関数
    async function displayByDate(date) {
      const folderId = getSavedFolderId();
      if (!folderId) { openFolderPicker(); return; }
      const ymd = dateToYMD(date);
      const success = await displayByBaseName(folderId, ymd);
      if (success) {
        currentDate = date; // 画像が見つかったときだけ更新
        prefetchAround(date, 3); // ★ ここで±3日を先読み
      }
    }

    // 先読みキャッシュ: 指定日を中心に±range日をキャッシュ
    async function prefetchAround(folderId, centerDateStr, range = 3) {
      const cache = await caches.open(CACHE_NAME);
      const centerDate = new Date(centerDateStr);

      for (let offset = -range; offset <= range; offset++) {
        const d = new Date(centerDate);
        d.setDate(centerDate.getDate() + offset);
        const ymd = d.toISOString().slice(0, 10); // YYYY-MM-DD

        // キャッシュ確認
        const cachedResponse = await cache.match(ymd);
        if (cachedResponse) {
          console.log(`📦 ${ymd}: キャッシュ済み`);
          continue;
        }

        // Google Drive から取得
        const file = await findImageFile(folderId, ymd);
        if (!file) {
          console.log(`🚫 ${ymd}: 画像なし`);
          continue;
        }

        const accessToken = await ensureToken();
        const url = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
        const resp = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });

        if (!resp.ok) {
          console.log(`⚠️ ${ymd}: 取得失敗 ${resp.status}`);
          continue;
        }

        // キャッシュ保存
        await cache.put(ymd, resp.clone());
        console.log(`✅ ${ymd}: キャッシュ保存`);
      }
    }

    function openFolderPicker() {
      $("#picker").style.display = "flex";
      loadFolderList();
    }

    async function loadFolderList() {
      try {
        const res = await gapi.client.drive.files.list({
          q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
          fields: "files(id,name)",
          pageSize: 100,
          orderBy: "name",
          includeItemsFromAllDrives: true,
          supportsAllDrives: true,
        });
        const sel = $("#folderList");
        sel.innerHTML = "";
        (res.result.files || []).forEach((f) => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.name;
          sel.appendChild(opt);
        });
      } catch (e) {
        setStatus("フォルダ取得エラー: " + e.message, true);
      }
    }

    function afterLogin() {
      setStatus("ログイン成功");
      $("#login").style.display = "none";
      $("#logout").style.display = "inline-block";
      $("#choose").style.display = "inline-block";
      $("#showToday").style.display = "inline-block";

      const saved = getSavedFolderId();
      if (saved) {
        $("#remembered").textContent = `選択中フォルダID: ${saved}`;
        displayToday();
      } else {
        openFolderPicker();
      }

      ["navDay","navYear"].forEach(id => {
      document.getElementById(id).style.display = "flex";
      });
    }

    // ====== イベント割り当て ======
    document.addEventListener("DOMContentLoaded", () => {
      $("#login").addEventListener("click", () => {
        tokenClient.callback = (resp) => {
          if (resp.error) {
            setStatus("認証エラー: " + resp.error, true);
            return;
          }
          gapi.client.setToken(resp); // gapi にアクセストークンを設定
          afterLogin();
        };
        tokenClient.requestAccessToken({ prompt: "consent" });
      });

      $("#logout").addEventListener("click", () => {
        try {
          google.accounts.oauth2.revoke(gapi.client.getToken()?.access_token || "", () => {});
        } catch (e) {
          console.warn("revoke でエラー:", e);
        }
        gapi.client.setToken("");
        setStatus("未ログイン");
        $("#login").style.display = "inline-block";
        $("#login").disabled = false;
        $("#logout").style.display = "none";
        $("#choose").style.display = "none";
        $("#showToday").style.display = "none";
        $("#picker").style.display = "none";
        $("#remembered").textContent = "";
        clearImage();
      });

      $("#choose").addEventListener("click", openFolderPicker);
      $("#saveFolder").addEventListener("click", () => {
        const id = $("#folderList").value;
        if (!id) { setStatus("フォルダを選択してください", true); return; }
        localStorage.setItem("selectedFolderId", id);
        $("#remembered").textContent = `選択中フォルダID: ${id}`;
        $("#picker").style.display = "none";
        displayToday();
      });

      $("#showToday").addEventListener("click", displayToday);

      $("#prevDay").addEventListener("click", () => {
        const d = new Date(currentDate);
        d.setDate(d.getDate() - 1);
      displayByDate(d);
      });

      $("#nextDay").addEventListener("click", () => {
        const d = new Date(currentDate);
        d.setDate(d.getDate() + 1);
        displayByDate(d);
      });

      $("#prevYear").addEventListener("click", () => {
        const d = new Date(currentDate);
        d.setFullYear(d.getFullYear() - 1);
        displayByDate(d);
      });

      $("#nextYear").addEventListener("click", () => {
        const d = new Date(currentDate);
        d.setFullYear(d.getFullYear() + 1);
        displayByDate(d);
      });
    });

    document.getElementById("checkCacheBtn").addEventListener("click", showCacheUsage);
    
    // ====== Google API 初期化 ======
    function gapiLoaded() {
      gapi.load("client", async () => {
        await gapi.client.init({
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
        });
        gapiReady = true;
        enableLoginIfReady();
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: () => {}, // 初期は空でOK（クリック時に上書き）
      });
      gisReady = true;
      enableLoginIfReady();
    }
    
    function enableLoginIfReady() {
      if (gapiReady && gisReady) {
        document.getElementById("login").disabled = false;
        document.getElementById("checkCacheBtn").disabled = false;
        setStatus("準備完了");
      }
    }
  </script>

  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
